# Credit Usage Monitor for Cascade Analytics

This tool monitors and reports on Cascade API credit usage across your organization, helping you identify users who are approaching or exceeding their credit limits.

## Overview

The Credit Usage Monitor analyzes user credit usage data from Cascade Analytics and flags users who are approaching or exceeding defined credit limits. It works with the output files generated by the `cascade_usage_analyzer.py` script.

## Workflow Scripts

The complete credit monitoring workflow consists of three main scripts that work together:

### 1. `get_unique_emails.py` (Email & API Key Collection)
**Purpose**: Fetches and maps user email addresses to their corresponding API keys
**What it does**:
- Queries the Cascade Analytics API to retrieve user data
- Extracts unique email addresses and their associated API keys
- Generates a JSON file mapping emails to API keys (e.g., `unique_emails_YYYY-MM-DD.json`)
- Supports date range filtering for targeted analysis

### 2. `cascade_usage_analyzer.py` (Usage Data Analysis)
**Purpose**: Analyzes credit usage data for each user
**What it does**:
- Reads the email-to-API-key mapping from the JSON file
- Fetches detailed usage data from the Cascade Analytics API for each API key
- Aggregates usage data by user, model, and date
- Calculates total prompt credits used per user
- Generates two output files:
  - Raw API responses: `cascade_api_raw_responses_YYYY-MM-DD.json`
  - User summary: `cascade_usage_by_user_YYYY-MM-DD.csv`

### 3. `credit_usage_monitor.py` (Credit Limit Monitoring)
**Purpose**: Monitors users against credit limits and generates alerts
**What it does**:
- Reads the user summary CSV file from the analyzer
- Calculates percentage of credit limit used for each user
- Identifies users who have reached specified threshold percentages (default: 75%, 85%, 95%)
- Generates a detailed report: `credit_usage_report_YYYY-MM-DD.csv`
- Provides summary statistics and recommendations

### 4. `cascade_credit_workflow.py` (Workflow Orchestrator)
**Purpose**: Automates the entire workflow by running all scripts in sequence
**What it does**:
- Orchestrates the execution of all three scripts above
- Handles file dependencies between scripts
- Provides real-time output and error handling
- Supports skipping steps for advanced use cases
- Generates timestamped output files
- Provides workflow completion summary and next steps

## Features

- **Configurable Credit Limit**: Set custom credit limits (default: 1500)
- **Flexible Threshold Monitoring**: Define your own threshold percentages (default: 75%, 85%, 95%)
- **Smart User Tracking**: Identifies users at each threshold level without double-counting
- **Detailed Reporting**: Generates CSV reports with usage statistics
- **Summary Statistics**: Provides clear overview of credit usage across your organization

## Prerequisites

- Python 3.6+
- pandas library (`pip install pandas`)
- Output files from `cascade_usage_analyzer.py` (specifically the `cascade_usage_by_user_*.csv` files)

## Installation

No special installation is required. Simply ensure you have the prerequisites installed:

```bash
pip install pandas
```

## Usage

### Basic Usage

Run the script with default settings:

```bash
python3 credit_usage_monitor.py
```

This will:
1. Find the most recent `cascade_usage_by_user_*.csv` file
2. Use the default credit limit of 1500
3. Flag users at 75%, 85%, and 95% thresholds
4. Generate a report named `credit_usage_report_YYYY-MM-DD.csv`

### Command Line Options

```
python3 credit_usage_monitor.py [options]
```

Options:
- `--credit-limit LIMIT`: Set the total credit limit (default: 1500)
- `--thresholds LIST`: Comma-separated list of threshold percentages (default: 75,85,95)
- `--input-file FILE`: Path to the input CSV file
- `--output-file FILE`: Path to the output report file

### Examples

Monitor with custom thresholds:
```bash
python3 credit_usage_monitor.py --thresholds 50,75,90
```

Set a different credit limit:
```bash
python3 credit_usage_monitor.py --credit-limit 2000
```

Specify input and output files:
```bash
python3 credit_usage_monitor.py --input-file custom_data.csv --output-file custom_report.csv
```

## Output

The script generates a CSV report with the following columns:
- `api_key`: The user's API key
- `email`: The user's email address
- `total_prompt_credits`: Total prompt credits used
- `percentage`: Percentage of credit limit used
- `threshold_reached`: The highest threshold reached by the user

## Usage

### Simplified Workflow

The easiest way to use this tool is with the `cascade_credit_workflow.py` script, which automates the entire process:

```bash
python3 cascade_credit_workflow.py [options]
```

This single command will:
1. Fetch API keys and email addresses
2. Analyze credit usage data
3. Generate a report of users approaching credit limits
4. Provide a summary of results and next steps

### Options

- `--start-date DATE`: Start date in YYYY-MM-DD format
- `--end-date DATE`: End date in YYYY-MM-DD format
- `--credit-limit LIMIT`: Set the total credit limit (default: 1500)
- `--thresholds LIST`: Comma-separated list of threshold percentages (default: 75,85,95)
- `--output-dir DIR`: Directory for output files (default: current directory)

### Examples

```bash
# Run with default settings (last 30 days of data)
python3 cascade_credit_workflow.py

# Run with custom date range and credit limit
python3 cascade_credit_workflow.py --start-date 2025-09-01 --end-date 2025-09-10 --credit-limit 2000
```

### Advanced Options

For more advanced use cases, you can skip certain steps:

- `--skip-emails`: Skip the email fetching step (use existing unique_emails.json)
- `--skip-analysis`: Skip the usage analysis step (use existing CSV file)
- `--emails-file FILE`: Path to existing unique_emails.json file
- `--summary-file FILE`: Path to existing cascade_usage_by_user_*.csv file

```bash
# Skip email fetching (use existing unique_emails.json)
python3 cascade_credit_workflow.py --skip-emails --emails-file unique_emails.json
```

### Next Steps

After running the workflow:
1. Review the credit usage report
2. Notify users approaching their limits
3. Adjust credit limits as needed
4. Implement any additional monitoring or notifications


## Troubleshooting

If you encounter issues:

1. Ensure your input CSV file has the required columns (`api_key`, `email`, `total_prompt_credits`)
2. Check that threshold values are valid numbers
3. Verify that the credit limit is appropriate for your organization

## Contributing

Feel free to modify this script to suit your organization's specific needs. Some possible enhancements:
- Email notifications for users approaching limits
- Integration with monitoring systems
- Historical trend analysis
